<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Finance Tracker Dashboard</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Try loading Material Icons with a fallback -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" onload="console.log('Material Icons loaded successfully')" onerror="console.error('Failed to load Material Icons')">
  
  <style>
    /* Your existing styles */
    .actions {
      display: flex;
      gap: 10px;
      justify-content: center;
    }
    .action-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 18px;
      transition: transform 0.2s;
      padding: 5px;
      border-radius: 4px;
      min-width: 30px;
      min-height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .action-btn:hover {
      transform: scale(1.2);
      background-color: rgba(0, 0, 0, 0.05);
    }
    .material-icons {
      vertical-align: middle;
      font-size: 20px;
    }
    
    /* Dynamic modal styling */
    .modal {
      display: flex;
      justify-content: center;
      align-items: center;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      z-index: 999;
    }
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 400px;
      position: relative;
    }
    .close-btn {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 22px;
      cursor: pointer;
    }
    
    /* Ensure the table has proper spacing */
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    th, td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    
    th {
      background-color: #f2f2f2;
    }
    
    /* Icon styling - make sure they're visible */
    .icon {
      display: inline-block;
      width: 20px;
      height: 20px;
      text-align: center;
      line-height: 20px;
    }
    
    /* Debug info */
    #debug-info {
      position: fixed;
      bottom: 10px;
      right: 10px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 12px;
      z-index: 1000;
    }
  </style>
</head>
<body>
  <!-- Your existing HTML content -->
  <div class="dashboard">
    <header>
      <h1>üíµ Personal Finance Tracker</h1>
      <p>Track your income, expenses & savings in real time.</p>
    </header>

    <section class="summary-cards">
      <div class="card income">
        <h3><span class="material-icons">attach_money</span> Income</h3>
        <p id="income">0 USD</p>
      </div>
      <div class="card expense">
        <h3><span class="material-icons">money_off</span> Expense</h3>
        <p id="expense">0 USD</p>
      </div>
      <div class="card balance">
        <h3><span class="material-icons">account_balance_wallet</span> Balance</h3>
        <p id="balance">0 USD</p>
      </div>
    </section>

    <section class="form-section">
      <h2>Add Transaction</h2>
      <form id="transaction-form">
        <input type="text" id="description" placeholder="Description" required />

        <select id="type" required>
          <option value="income">Income</option>
          <option value="expense">Expense</option>
        </select>

        <select id="category" required>
          <option value="" disabled selected>Select Category</option>
          <!-- Income categories -->
          <option value="Salary" data-type="income">Salary</option>
          <option value="Freelance" data-type="income">Freelance</option>
          <option value="Investment" data-type="income">Investment</option>
          <!-- Expense categories -->
          <option value="Food" data-type="expense">Food</option>
          <option value="Transport" data-type="expense">Transport</option>
          <option value="Entertainment" data-type="expense">Entertainment</option>
          <option value="Bills" data-type="expense">Bills</option>
        </select>

        <input type="number" id="amount" placeholder="Amount" required />

        <button type="submit">Add</button>
      </form>
    </section>

    <section class="chart-section">
      <h2>Monthly Summary</h2>
      <canvas id="financeChart"></canvas>
    </section>

    <section class="table-section">
      <h2>Transaction History</h2>
      <table>
        <thead>
          <tr>
            <th>Description</th>
            <th>Category</th>
            <th>Amount (USD)</th>
            <th>Type</th>
            <th>Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="transactions-table"></tbody>
      </table>
    </section>
  </div>

  <!-- Debug info to help identify the issue -->
  <div id="debug-info">Checking icons...</div>

  <script>
    const API_URL = "http://127.0.0.1:5000";
    let financeChart;
    let materialIconsLoaded = false;

    // Check if Material Icons loaded
    document.addEventListener("DOMContentLoaded", () => {
      // Check if Material Icons loaded
      setTimeout(() => {
        const testElement = document.createElement('span');
        testElement.className = 'material-icons';
        testElement.style.display = 'none';
        testElement.textContent = 'home';
        document.body.appendChild(testElement);
        
        const computedStyle = window.getComputedStyle(testElement);
        const fontFamily = computedStyle.getPropertyValue('font-family');
        
        materialIconsLoaded = fontFamily.includes('Material Icons');
        
        // Update debug info
        document.getElementById('debug-info').textContent = 
          `Material Icons: ${materialIconsLoaded ? 'Loaded' : 'Not loaded'}`;
        
        document.body.removeChild(testElement);
        
        // Continue with initialization
        initializeApp();
      }, 1000);
    });

    function initializeApp() {
      const typeSelect = document.getElementById("type");
      const categorySelect = document.getElementById("category");

      // Filter categories based on type
      typeSelect.addEventListener("change", () => {
        const selectedType = typeSelect.value;
        Array.from(categorySelect.options).forEach(option => {
          if (!option.value) return;
          option.style.display = option.dataset.type === selectedType ? "block" : "none";
        });
        categorySelect.value = "";
      });

      typeSelect.dispatchEvent(new Event("change"));
      loadTransactions();

      // Add Transaction
      document.getElementById("transaction-form").addEventListener("submit", async (e) => {
        e.preventDefault();

        const description = document.getElementById("description").value.trim();
        const type = typeSelect.value;
        const category = categorySelect.value;
        const amount = parseFloat(document.getElementById("amount").value);

        if (!description || !category || isNaN(amount)) {
          alert("Please fill in all fields correctly.");
          return;
        }

        await fetch(`${API_URL}/transactions`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ description, category, amount, type })
        });

        e.target.reset();
        typeSelect.dispatchEvent(new Event("change"));
        loadTransactions();
      });
    }

    // Load and render transactions
    async function loadTransactions() {
      try {
        const res = await fetch(`${API_URL}/transactions`);
        const data = await res.json();

        const table = document.getElementById("transactions-table");
        table.innerHTML = "";

        let incomeTotal = 0, expenseTotal = 0;

        data.forEach((tx) => {
          if (tx.type === "income") incomeTotal += tx.amount;
          else expenseTotal += tx.amount;

          const row = document.createElement("tr");
          row.style.transition = "opacity 0.5s ease";

          // Use emoji icons directly instead of Material Icons for reliability
          row.innerHTML = `
            <td>${tx.description}</td>
            <td>${tx.category}</td>
            <td>${tx.amount.toFixed(2)}</td>
            <td style="color:${tx.type === 'income' ? 'green' : 'red'}; font-weight: bold;">
              ${tx.type === 'income' ? 'üí∞ Income' : 'üí∏ Expense'}
            </td>
            <td>${new Date(tx.date).toLocaleDateString()}</td>
            <td class="actions">
              <button class="action-btn view-btn" data-id="${tx.id}" title="View">
                <span class="icon" style="color:green;">üëÅ</span>
              </button>
              <button class="action-btn edit-btn" data-id="${tx.id}" title="Edit">
                <span class="icon" style="color:blue;">‚úèÔ∏è</span>
              </button>
              <button class="action-btn delete-btn" data-id="${tx.id}" title="Delete">
                <span class="icon" style="color:red;">üóëÔ∏è</span>
              </button>
            </td>
          `;
          table.appendChild(row);
        });

        // DELETE transaction
        document.querySelectorAll(".delete-btn").forEach(btn => {
          btn.addEventListener("click", async () => {
            const id = btn.dataset.id;
            const row = btn.closest("tr");

            if (!confirm("Are you sure you want to delete this transaction?")) return;

            row.style.opacity = 0;
            setTimeout(async () => {
              await fetch(`${API_URL}/transactions/${id}`, { method: "DELETE" });
              loadTransactions();
            }, 400);
          });
        });

        // VIEW transaction
        document.querySelectorAll(".view-btn").forEach(btn => {
          btn.addEventListener("click", async () => {
            const id = btn.dataset.id;
            const tx = data.find(t => t.id == id);
            showModal(`
              <h2>Transaction Details</h2>
              <p><strong>Description:</strong> ${tx.description}</p>
              <p><strong>Category:</strong> ${tx.category}</p>
              <p><strong>Amount:</strong> ${tx.amount.toFixed(2)} USD</p>
              <p><strong>Type:</strong> ${tx.type}</p>
              <p><strong>Date:</strong> ${new Date(tx.date).toLocaleString()}</p>
              <button onclick="closeModal()">Close</button>
            `);
          });
        });

        // EDIT transaction
        document.querySelectorAll(".edit-btn").forEach(btn => {
          btn.addEventListener("click", async () => {
            const id = btn.dataset.id;
            const tx = data.find(t => t.id == id);
            if (!tx) return;

            showModal(`
              <h2>Edit Transaction</h2>
              <form id="edit-form">
                <label>Description</label>
                <input type="text" id="edit-description" value="${tx.description}" required />
                
                <label>Category</label>
                <input type="text" id="edit-category" value="${tx.category}" required />
                
                <label>Amount</label>
                <input type="number" id="edit-amount" value="${tx.amount}" min="0.01" required />
                
                <label>Type</label>
                <select id="edit-type" required>
                  <option value="income" ${tx.type === "income" ? "selected" : ""}>Income</option>
                  <option value="expense" ${tx.type === "expense" ? "selected" : ""}>Expense</option>
                </select>
                
                <div style="margin-top:15px; display:flex; justify-content:space-between;">
                  <button type="submit">Save Changes</button>
                  <button type="button" onclick="closeModal()">Cancel</button>
                </div>
              </form>
            `);

            document.getElementById("edit-form").addEventListener("submit", async (e) => {
              e.preventDefault();

              const updatedData = {
                description: document.getElementById("edit-description").value,
                category: document.getElementById("edit-category").value,
                amount: parseFloat(document.getElementById("edit-amount").value),
                type: document.getElementById("edit-type").value
              };

              await fetch(`${API_URL}/transactions/${id}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(updatedData)
              });

              closeModal();
              loadTransactions();
            });
          });
        });

        // Summary update
        const balance = incomeTotal - expenseTotal;
        document.getElementById("income").textContent = incomeTotal.toFixed(2) + " USD";
        document.getElementById("expense").textContent = expenseTotal.toFixed(2) + " USD";
        document.getElementById("balance").textContent = balance.toFixed(2) + " USD";

        renderChart(incomeTotal, expenseTotal);
      } catch (error) {
        console.error("Error loading transactions:", error);
        document.getElementById("debug-info").textContent = `Error: ${error.message}`;
      }
    }

    // Chart rendering
    function renderChart(income, expense) {
      const ctx = document.getElementById("financeChart").getContext("2d");

      if (financeChart) financeChart.destroy();

      financeChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: ["Income", "Expense"],
          datasets: [{
            label: "Finance Overview",
            data: [income, expense],
            backgroundColor: ["#43a047", "#e53935"]
          }]
        },
        options: { responsive: true, scales: { y: { beginAtZero: true } } }
      });
    }

    // Helper: create modal dynamically
    function showModal(contentHTML) {
      const modal = document.createElement("div");
      modal.className = "modal";
      modal.innerHTML = `
        <div class="modal-content">
          <span class="close-btn" onclick="closeModal()">&times;</span>
          ${contentHTML}
        </div>
      `;
      document.body.appendChild(modal);
    }

    function closeModal() {
      const modal = document.querySelector(".modal");
      if (modal) modal.remove();
    }
  </script>
</body>
</html>